<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PAIE Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body class="app">

  <!-- Drawer toggle -->
  <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />

  <!-- Top bar -->
  <header class="topbar">
    <label for="drawer-toggle" class="btn ghost" title="Open sessions">☰</label>
    <div class="brand">PAIE — Local Chat</div>
    <div class="spacer"></div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>Sessions</h3>
        <label for="drawer-toggle" class="btn ghost close">×</label>
      </div>

      <nav class="sessions">
        <ul>
          {% for s in sessions %}
          <li class="session-item {% if s.id == session_id %}active{% endif %}">
            <a class="session-link" href="/?session_id={{ s.id }}">{{ s.title }}</a>
            <div class="session-meta">{{ s.created_at }}</div>
          </li>
          {% endfor %}
        </ul>
      </nav>

      <div class="new-session">
        <h4>New session</h4>
        <form hx-post="/api/sessions"
              hx-swap="none"
              hx-on::after-request="try{const r=JSON.parse(event.detail.xhr.responseText); window.location='/?session_id='+r.id;}catch(e){window.location.reload();}">
          <input class="input" type="text" name="title" placeholder="Title (optional)" />
          <button class="btn primary" type="submit">Create</button>
        </form>
      </div>
    </aside>

    <!-- Main -->
    <main class="content">

      <!-- System Prompt (collapsible) -->
      <section class="card collapsible">
        <details {% if system_prompt %}open{% endif %}>
          <summary class="card-header as-summary">
            <div class="card-title">System Prompt</div>
            <div class="card-subtitle">Controls instruction/persona</div>
          </summary>

          <div class="card-body">
            <form hx-post="/api/system"
                  hx-swap="none"
                  hx-include="[name=session_id]">
              <input type="hidden" name="session_id" value="{{ session_id }}" />
              <textarea class="textarea lg" name="prompt" rows="3" placeholder="Set persona/instruction…">{{ system_prompt }}</textarea>
              <div class="card-footer row">
                <button class="btn primary" type="submit">Update Prompt</button>
                <button class="btn subtle" type="button"
                        hx-delete="/api/system?session_id={{ session_id }}"
                        hx-swap="none">Clear</button>
              </div>
            </form>
          </div>
        </details>
      </section>

      <!-- Chat -->
      <section class="chat card">
        <div class="card-header">
          <div class="card-title truncate" title="{{ session_title }}">{{ session_title }}</div>
          <div class="card-subtitle">Session #{{ session_id }}</div>
          <div class="card-actions">

            <!-- Rename (inline) -->
            <details class="rename-wrap">
              <summary class="btn subtle">Rename</summary>
              <form class="rename-form"
                    hx-post="/api/sessions/rename"
                    hx-swap="none"
                    hx-indicator=".rename-indicator"
                    hx-on::after-request="try{const r=JSON.parse(event.detail.xhr.responseText); window.location='/?session_id='+r.id;}catch(e){window.location.reload();}">
                <input type="hidden" name="session_id" value="{{ session_id }}" />
                <input class="input" type="text" name="title" value="{{ session_title }}" />
                <div class="row">
                  <button class="btn primary" type="submit">Save</button>
                  <div class="rename-indicator htmx-indicator">Saving…</div>
                </div>
              </form>
            </details>

          </div>
        </div>

        <!-- Messages -->
        <div id="chatbox"
             class="chatbox"
             hx-get="/fragment/messages?session_id={{ session_id }}"
             hx-trigger="load, every 1.5s, refresh from:body"
             hx-swap="innerHTML">
        </div>

        <!-- Input -->
        <form class="chat-input"
              hx-post="/api/chat"
              hx-swap="none"
              hx-include="[name=session_id]"
              hx-disabled-elt="find button, textarea"
              hx-indicator=".send-indicator"
              hx-on::after-request="this.reset(); htmx.trigger('#chatbox','refresh')">
          <input type="hidden" name="session_id" value="{{ session_id }}" />
          <textarea class="textarea rounded lg" name="text" rows="3" placeholder="Type your message… (Shift+Enter for new line)"></textarea>
          <div class="row">
            <div class="send-indicator htmx-indicator">Sending…</div>
            <button class="btn primary" type="submit" title="Send">Send</button>
          </div>
        </form>
      </section>

    </main>
  </div>

  <!-- Autoscroll to bottom after message refresh -->
  <script>
    document.body.addEventListener('htmx:afterSwap', function (e) {
      if (e.detail && e.detail.target && e.detail.target.id === 'chatbox') {
        const box = document.getElementById('chatbox');
        box.scrollTop = box.scrollHeight;
      }
    });
  </script>
</body>
</html>
